## SQL注入

#### 注入原理：

> 主要原因是程序员在开发用户和数据库交互的系统时没有**对用户输入的字符串进行过滤**，转义，限制或处理不严谨，导致用户可以通过输入精心构造的字符串去非法获取到数据库中的数据。

一般用户登录用的SQL语句为：`SELECT * FROM user WHERE username='admin' AND password='passwd'`，此处admin和passwd分别为用户输入的用户名和密码，如果程序员没有对用户输入的用户名和密码做处理，就可以构造万能密码成功绕过登录验证，如用户输入`'or 1#`,SQL语句将变为：`SELECT * FROM user WHERE username=''or 1#' AND password=''`，`''or 1`为TRUE，#注释掉后面的内容，所以查询语句可以正确执行。

#### SQL注入分类及判断

按数据类型可以分为*数字型、字符型和搜索型*，按提交方式可分为*GET型，POST型*，Cookie型和HTTP请求头注入，按执行效果有可以分为报错注入、联合查询注入、盲注和堆查询注入，其中盲注又可分为基于bool的和基于时间的注入。

从查询语句及可看出来这里是字符型的注入同时也是GET型注入和表单注入，`数字型注入查询语句为：SELECT * FROM user WHERE id=1,搜索型注入为查询语句为：SELECT * FROM user WHERE search like '%1%'。`



在知道查询语句的情况下我们很容易辨别是否存在注入及注入类型，很多时候我们并不知道查询语句是什么，所以我们可以这样判断，**在URL或者表单中输入一个单引号或者其他特殊符号，页面出现错误说明此页面存在SQL注入**，如果页面正常显示说明有字符被过滤或者不存在注入。

如果存在注入可以进一步判断注入类型，**在URL或者表单中输入0 or 1，如果可以查到数据，说明是数字型注入，如果输入0'or 1#，查到数据说明是字符型注入，方法不唯一。**

总之==数字型注入不需要使用单引号闭合前面的单引号就可以执行SQL语句，而字符型必须闭合前面的单引号，然后才可以执行SQL语句，同时也需要把后面的单引号闭合，而注释就是很好的一种闭合后面的单引号的方法==。

GET型注入很容易从URL中看出来，如图，网页的URL为：http://127.0.0.1/DVWA/vulnerabilities/sqli/?id=1，**浏览器通常使用?来表示GET方法传递参数，而使用POST传递参数是不会显示到URL中的**，因此URL中含有？说明就是使用GET方法传递参数

#### SQL注入方法

- 注入方法可以直接在URL中提交注入语句，需要注意的是，**在URL提交SQL语句，需要将注释符#进行URL编码**，有时候所有SQL语句都需要URL编码。

- 联合查询注入

  > 联合查询注入也是用的非常多的，可以在URL中提交SQL语句，也可以在表单提交，联合查询相当于把别的表的数据查询结果显示到当前表，**使用联合查询时，必须使得两张表的表结构一致，因此我们需要判断当前表的列数有多少列**，此外还需知道是字符型注入还是数字型注入，由前面实验可知这是字符型注入，所以我们闭合前面的单引号，构造联合注入语句，**输入1'order by 1#，页面正常，然后输入1'order by 2#，依次增加，直到3时出现错误，说明当前表有2列**。
  >
  > ![image-20210406091323924](image/image-20210406091323924.png)

#### 防止SQL注入

- **（简单又有效的方法）PreparedStatement**  采用预编译语句集，它内置了处理SQL注入的能力，只要使用它的setXXX方法传值即可。

  > sql注入只对sql语句的准备(编译)过程有破坏作用。而PreparedStatement已经准备好了,执行阶段只是把输入串作为数据处理, 而不再对sql语句进行解析,准备,因此也就避免了sql注入问题。

- **使用正则表达式过滤传入的参数**

- **字符串过滤**

- **检查是否包函非法字符**

- **使用javascript在客户端进行不安全字符屏蔽**

  > 功能介绍：检查是否含有”''“，”\\“，”、“
  >
  > 参数说明：要检查的字符串
  >
  > 返回值：0：是1：不是

